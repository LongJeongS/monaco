!function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var i=this.Monaco=this.Monaco||{},o=i.Application=function(t,r){if(!t)throw new Error("Monaco :: missing required application parameter: appName");r=r||{},this.name=t,this.options=r,this.cid=e.uniqueId("app"),this._settings={},this.models={},this.collections={},this.views={};var o=r.RouterClass||i.Router;this.router=new o({app:this,routes:r.routes}),i.trigger("app:built",this,r)};e.extend(o.prototype,t.Events,{start:function(t){if(t=t||{},t.pushState=t.pushState||!1,!e.has(this,"router"))throw new Error("Monaco :: missing required router instance before starting the application");this.router._addRoutes(),i.history.start(t),i.trigger("app:initialized",this,t)},add:function(e,t){if(!t.prototype||!t.prototype.namespace)throw new Error("Monaco :: missing required object property 'namespace'");if(this[t.prototype.namespace][e])throw new Error("Monaco :: "+e+" have already been defined in "+this.name+"."+t.prototype.namespace);t.prototype._app=this,this[t.prototype.namespace][e]=t},get:function(t){if(e.has(this._settings,t))return this._settings[t];var i=null;try{i=JSON.parse(r.getItem(t))}catch(o){return void 0}return null===i?void 0:(this._settings[t]=i,i)},set:function(e,t,i){if(i=i||!1,void 0===e||void 0===t)throw new Error("set method required both key and value parameters { key: "+e+" | value: "+t+" }");if(this._settings[e]=t,i===!0)try{r.setItem(e,JSON.stringify(t))}catch(o){return!1}return!0}}),e.extend(i,t.Events);var n=function(e){e=e||{};var t=e.error,r=this._app&this._app.router?this._app.router:null;return e.error=function(e,i,o){r&&r.trigger("route:fetch.error",e,i,o),t&&t.apply(this,arguments)},e},s=function(e){return e=n.call(this,e),t.Collection.prototype.fetch.call(this,e)};try{i.Collection=t.Collection.extend({namespace:"collections",fetch:s})}catch(a){i.Collection=t.Collection,i.Collection.prototype.namespace="collections",i.Collection.prototype.fetch=s}var c=function(e){return e=n.call(this,e),t.Model.prototype.fetch.call(this,e)};try{i.Model=t.Model.extend({namespace:"models",fetch:c})}catch(a){i.Model=t.Model,i.Model.prototype.namespace="models",i.Model.prototype.fetch=c}return i.View=t.View.extend({namespace:"views"}),i.Router=t.Router.extend({_uroutes:[],_routes:[],constructor:function(){this.app=arguments.length>0?arguments[0].app:void 0;var r=this.initialize;this.initialize=function(t){e.each(t.routes,function(e,t){this._routes.push({key:t,value:e})},this),r.apply(this,arguments)},t.Router.prototype.constructor.apply(this,arguments)},add:function(t){var r,i;if(!t||!e.isObject(t))throw new Error("invalid routes format - please check the docs");for(i=e.keys(t);r=i.pop();)this._uroutes.unshift({key:r,value:t[r]})},_addRoutes:function(){for(var e;e=this._uroutes.pop();)this._routes.push(e),this._addRoute(e.key,e.value)},_addRoute:function(t,r){if(r=r||{},""!==t&&!t)throw new Error("invalid route: "+t);var i=null;if(e.isString(r)?i=r:e.isArray(r)&&r.length>0&&(i=r[0]),!i)throw new Error("invalid callback from route: "+t);return this.route(t,i)}}),i.History=t.History,i.history=t.history,i}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e){var t=this.Monaco=this.Monaco||{},r=/\((.*?)\)/g,i=/(\(\?)?:\w+/g,o=/\*\w+/g,n=/[\-{}\[\]+?.,\\\^$|#\s]/g;return t.Router.prototype._routeConstraints=function(t){var r=e.find(this._routes,function(e){return e.key===t});return r&&r.value&&e.isArray(r.value)&&r.value.length>1&&e.isObject(r.value[1])?r.value[1].regexp:void 0},t.Router.prototype._routeToRegExp=function(e){var t=this._routeConstraints(e);return e=e.replace(n,"\\$&").replace(r,"(?:$1)?").replace(i,function(e,r){if(t&&t[e.substr(1)]){var i=t[e.substr(1)].toString();return"("+i.slice(1,i.lastIndexOf("/"))+")"}return r?e:"([^/]+)"}).replace(o,"(.*?)"),new RegExp("^"+e+"$")},t.Router.prototype.filter=function(e,t){for(var r,i=e.length-1,o=0;i>=o;i--)r=t,t=this._wrapFilter(e[i],r);return t},t.Router.prototype._filters={},t.Router.prototype._wrapFilter=function(t,r){return e.bind(function(){this._filters[t].call(this,r,arguments)},this)},t.Router.prototype.addFilter=function(e,t){if(this._filters[e])throw new Error("Monaco :: filter already exists: "+e);this._filters[e]=t},t.Router.prototype._getByName=function(t){var r=e.map(this._routes,function(r,i){return e.isArray(r)&&r.length>1&&(e.isString(r[1])&&r[1]===t||e.isObject(r[1])&&r.name===t)?i:null}),i=e.compact(r);return i.length>0?i[0]:!1},t.Router.prototype.reverse=function(t,r){var i="";if(r=r||{},!t)throw new Error("Monaco :: required `name` parameter for `reverse` method");return i=this._getByName(t),e.each(r,function(e,t){i=i.replace(":"+t,e)}),i},t}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e){var t=this.Monaco=this.Monaco||{},r=t.View;return t.View=r.extend({namespace:"views",views:{},constructor:function(t){t=t||{},r.prototype.constructor.apply(this,arguments),t.template&&(this.template=t.template),this.children={},e.each(this.views,this._subviewConstructor,this);var i=this.render;this.render=e.bind(function(){return i.apply(this,arguments),this._subviewsRender.apply(this,arguments),this.trigger("rendered",this),this},this);var o=this.remove;this.remove=e.bind(function(){return this._subviewsRemove.apply(this,arguments),o.apply(this,arguments),this.trigger("removed",this),this},this)},render:function(t){return this.template&&(t=e.extend(t,this.collection?this.collection.toJSON():this.model?this.model.toJSON():{}),this.$el.append(this.template(t))),this},add:function(t){var r=e.keys(t),i=r[0],o=t[i];if(!i||!o)throw new Error("Monaco :: Invalid subview parameters");this._subviewConstructor(o,i)},_subviewConstructor:function(e,r){var i,o={};e=e||{},i=e.viewClass?e.viewClass.call(this):t.View;var n=e.collection?e.collection.call(this):this.collection;if(n&&!e.collectionItem?o.collection=n:(e.model||this.model)&&(o.model=e.model||this.model),e.template&&(o.template=e.template),n&&e.collectionItem)this._subviewPerModelConstructor(r,n,e,o,i);else{var s=new i(o);s.parent=this,this.children[r]=s}},_subviewPerModelConstructor:function(r,i,o,n,s){var a=this.views[r].suffix=o.suffix=o.suffix||e.uniqueId("sfx");this[a]={},this[a].addOne||(this[a].addOne=e.bind(function(){var e=Array.prototype.slice.call(arguments,0);return e.push({itemView:s,listWrapper:r,callback:function(e){e.parent=this,this.children[r].push(e)},context:this}),t.ViewForModels.prototype.addOne.apply(this[a],e)},this)),this[a].addAll||(this[a].addAll=e.bind(function(){var e=Array.prototype.slice.call(arguments,0);return e.push({itemView:s,listWrapper:r,callback:function(e){e.parent=this,this.children[r].push(e)},context:this}),t.ViewForModels.prototype.addAll.apply(this[a],e)},this)),this.listenTo(i,"add",e.bind(this[a].addOne,this[a])),this.listenTo(i,"reset",e.bind(this[a].addAll,this[a])),this.children[r]=[],i.each(function(t){var i=e.clone(n);i.model=t;var o=new s(i);o.parent=this,this.children[r].push(o)},this)},_subviewsRender:function(){var r=arguments;e.each(this.children,function(i,o){if(i instanceof t.View){var n=this.views[o];e.has(n,"autoRender")&&n.autoRender!==!0||(i.collection&&n.collectionItem?i[n.suffix].addAll(i.collection,{},{itemView:n.viewClass?n.viewClass.call(i):t.ViewClass,listWrapper:o}):this.$el.find(o).append(i.render.apply(i,r).el))}},this)},_subviewsRemove:function(){var t=arguments;e.each(this.children,function(r,i){var o=this.views[i];if(e.isArray(r)){for(var n=0,s=r.length;s>n;n++)r[n].remove.apply(r,t);this.stopListening(this.collection,"add",this[o.suffix].addOne),this.stopListening(this.collection,"reset",this[o.suffix].addAll),delete this[o.suffix]}else r.remove.apply(r,t)},this),this.children={}}}),t.ViewForModels=t.View.extend({addOne:function(e,r,i,o,n){r instanceof t.Collection||(n=o,o=i,i=r,r=null);var s=o.itemView||this.itemView,a=new s({model:e}),c=a.render(e.toJSON()).el;return o&&o.callback&&o.callback.call(o.context||this,a),n===!0?c:void 0},addAll:function(e,t,r){var i=[];t=t||{},!t.keepValues,e.each(function(e){i.push(this.addOne(e,t,r,!0))},this)}}),t}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var i=this.Monaco=this.Monaco||{};i.on("app:built",function(t,r){if(t.local._app=t,e.has(r,"cacheLocal")&&(t.local.autoCache=Boolean(e.result(r,"cacheLocal"))),e.has(r,"cacheExpire")){var i=e.result(r,"cacheExpire");t.local.cacheExpire=e.isNull(i)||e.isNumber(i)?i:void 0}r.prefetched&&(e.each(r.prefetched,function(e,t){e.data&&this.local.set({resource:t,models:[]},e.data,e.expire)},t),delete t.options.prefetched)});var o=i.Application.prototype.add;i.Application.prototype.add=function(e,t){if("collections"===t.prototype.namespace&&(!t.prototype.resource||""===t.prototype.resource))throw new Error("Monaco :: required `resource` property missing from this collection definition");return o.apply(this,arguments)},i.Application.prototype.local={autoCache:!1,cacheExpire:30,get:function(t){var r=e.has(t,"models"),i=r?t:t.collection||null,o=i?e.result(i,"resource"):e.result(t,"resource");if(o){var n=this._getLocalData(o);if(n){if(n.resp=this.decompress(n.resp),r)return n.resp;if(i){if(n=e.find(i.parse(n.resp),function(e){return e[t.idAttribute]===t.id}),n&&(!n._ts||!this._isExpired(n)))return delete n._ts,n}else if(n.resp[t.idAttribute]===t.id)return n.resp}}return void 0},set:function(t,r,i){var o=e.has(t,"models"),n=o?t:t.collection||null,s=n?e.result(n,"resource"):e.result(t,"resource");if(i=void 0!==i?i:!1,s){if(!o&&n){var a=i||e.result(t,"expireLocal");a&&(r=this._setExpire(r,a,!0)),r=this._addToCollectionData(t,r,n),i=i!==!1?i:e.result(n,"expireLocal")}else i=i!==!1?i:e.result(t,"expireLocal");return r=this.compress(r),r=this._setExpire(r,i),this._storageSet(s,r),this._memorySet(s,r),!0}},clear:function(e){return e=e||null,e?this._clearItem(e):this._clearAll()},compress:function(e){return e},decompress:function(e){return e},_getLocalData:function(t){for(var r=null,i=["memory","storage"],o=0,n=i.length;n>o;o++){if(r=this["_"+i[o]+"Get"](t),r&&!this._isExpired(r))return"storage"===i[o]&&this._memorySet(t,r),e.clone(r);r&&this.clear(t)}return null},_addToCollectionData:function(e,t,r){var i,o=this.get(r);return o&&(i=r.parse(o),r.reset(i,{silent:!0})),r.add(t,{silent:!0,merge:!0}),r.revertParse&&"function"==typeof r.revertParse?r.revertParse():r.toJSON()},_memoryGet:function(e){return this._memory?this._memory[e]:null},_memorySet:function(e,t){this._memory=this._memory||{},this._memory[e]=t},_storageGet:function(e){var t;try{t=r.getItem(this._getKey(e))}catch(i){return null}return void 0===t||"undefined"===t||null===t?null:JSON.parse(t)},_storageSet:function(e,t){var i,o=this._getKey(e);try{i=r.getItem("monaco-"+this._app.name+":keys")||"{}"}catch(n){return}var s=JSON.parse(i);s[o]=t._ts;try{r.setItem("monaco-"+this._app.name+":keys",JSON.stringify(s)),r.setItem(o,JSON.stringify(t))}catch(n){try{r.setItem("monaco-"+this._app.name+":keys",i)}catch(a){}}},_setExpire:function(t,r,i){var o=null;if(r=e.isNumber(r)||e.isNull(r)?r:void 0,!e.isNull(r)){var n=new Date;n.setMinutes(n.getMinutes()+(r||this.cacheExpire)),o=n.getTime()}return i===!0?(t._ts=o,t):{_ts:o,resp:t}},_isExpired:function(t){var r=t._ts,i=new Date;return!e.isNull(r)&&i.getTime()>r},_clearItem:function(t){var i=this._getKey(t);try{r.removeItem(i)}catch(o){throw new Error("Monaco :: unable to remove the localStorage key: "+i)}e.has(this._memory,t)&&delete this._memory[t];var n;try{n=JSON.parse(r.getItem("monaco-"+this._app.name+":keys"))||{}}catch(o){}return n?(delete n[i],this._app.set("monaco-"+this._app.name+":keys",n,!0)):void 0},_clearAll:function(){var t={};try{t=JSON.parse(r.getItem("monaco-"+this._app.name+":keys"))||{}}catch(i){}e.each(t,function(e,t){try{var i=t.split("#");i=i[1],r.removeItem(t)}catch(o){}},this),this._memory={},this._app.set("monaco-"+this._app.name+":keys",{},!0)},_getKey:function(e){return this._app.name+"#"+e}};var n=i.Collection.prototype.initialize;i.Collection.prototype.initialize=function(){return this.on("add remove change reset",function(){var t,r=arguments.length>0?arguments[arguments.length-1]:{};r.fromLocal||e.result(this,"cacheLocal")!==!0&&this._app.local.autoCache!==!0||(t=this.revertParse&&"function"==typeof this.revertParse?this.revertParse():this.toJSON(),this._app.local.set(this,t))},this),n.apply(this,arguments)};var s=i.Model.prototype.initialize;return i.Model.prototype.initialize=function(){return this.on("change",function(){var t,r=arguments.length>0?arguments[arguments.length-1]:{};!r.fromLocal&&(e.result(this,"cacheLocal")===!0||this._app&&this._app.local.autoCache===!0)&&(t=this.revertParse&&"function"==typeof this.revertParse?this.revertParse():this.toJSON(),this._app.local.set(this,t))},this),s.apply(this,arguments)},i.sync=t.sync,t.sync=function(t,r,o){o=o||{};var n=r._app,s=o.localOnly===!0||r.localOnly===!0;if(n&&"read"===t){var a=o.fresh===!0?null:n.local.get(r);if(a)return o.fromLocal=!0,o.success&&o.success(a),!0;var c=e.has(r,"models");if(s===!0)return void(o.error&&o.error({},"Error: resource not found locally",{}));var l,u=!1,h=c&&r.cachePolicy?r.cachePolicy:!c&&r.collection?r.collection.cachePolicy:n.options.cachePolicy?n.options.cachePolicy:void 0;u=h&&"local"!==h,(e.result(o,"cacheLocal")===!0||!e.has(o,"cacheLocal")&&c&&e.result(r,"cacheLocal")===!0||!e.has(o,"cacheLocal")&&!c&&r.collection&&e.result(r.collection,"cacheLocal")===!0||!e.has(o,"cacheLocal")&&!c&&!r.collection&&e.result(r,"cacheLocal")===!0||!e.has(o,"cacheLocal")&&!e.has(r,"cacheLocal")&&n.local.autoCache===!0)&&(u=!0),u&&(l=o.success,o.success=function(t,i,s){if(h&&"local"!==h){var a=s.getResponseHeader(h);a&&(a=parseInt(a.match(/max-age=([\d]+)/)[1],10),a&&a/60>0&&n.local.set(r,t,a/60))}else n.local.set(r,t,e.result(o,"expireLocal"));l&&l.apply(this,arguments)})}if(s!==!0)return i.sync(t,r,o)},i}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(){var e=this.Monaco=this.Monaco||{},t=this.Monaco.History.prototype.loadUrl,r=this;return e.History.prototype.loadUrl=function(){var e=t.apply(this,arguments),r=this.fragment;return/^\//.test(r)||(r="/"+r),this.trackPageview(r),e},e.History.prototype.trackPageview=function(e){void 0!==r.ga&&r.ga("send","pageview",e)},e}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e){var t=this.Monaco=this.Monaco||{};t.on("app:built",function(e,r){e.experiments=new t.Experiments(r.experiments)});var r=t.Experiments=function(t){t=t||{},this._experiments=[],this.options=e.extend({ga:{slot:1,scope:2},cookie:{prefix:"ab-",days:360,baseDomain:!1}},t)};r.prototype=e.extend(r.prototype,{get:function(t){return e.find(this._experiments,function(e){return e.key===t})},set:function(r,i,o){var n=r;n instanceof t.Experiment||(n=new t.Experiment(this,r,i,e.extend(this.options,o))),this._experiments.push(n)},optout:function(){e.each(this._experiments,function(e){e.optout()})},split:function(){e.each(this._experiments,function(e){e.split()})}});var i=t.Experiment=function(r,i,o,n){if(!i)throw new Error("Monaco :: failed to create the experiment: "+i+" - experiment key required");if(o=o||{},n=n||{},n.users=n.users||0,!e.isNumber(n.users)||n.users>1||n.users<0)throw new Error("Monaco :: failed processing experiment: '"+i+"' - users not defined within allowed range");if(this.usersPerGroup=Math.floor(100*n.users/e.size(o)),this.usersPerGroup<1)throw new Error("Monaco :: failed processing experiment: '"+i+"' - individual groups set to less than 1%");this.parent=r,this.key=i,this.groups=o,this.normalized=this._normalizeGroup(o),this.options=n,this.cookie={set:t.utils.setCookie,get:t.utils.getCookie}};return i.prototype=e.extend(i.prototype,{original:"__original__",current:null,split:function(){if(!this.current){var e=this.options.cookie,t=this.cookie.get(e.prefix+this.key);t||(t=this.normalized[Math.floor(Math.random()*this.normalized.length)],this.cookie.set(e.prefix+this.key,t,e.days,e.baseDomain),this.saveGroup(t)),this.current=t}return this.current},get:function(e){return!e&&this.current?this.groups[this.current]:e?this.groups[e]:void 0},controller:function(e){return this.current&&this.current!==this.original?e+this.get(this.current).suffix:e},view:function(e){return this.current&&this.current!==this.original?e+this.get(this.current).suffix:e},template:function(e){return this.current&&this.current!==this.original?e+"."+this.get(this.current).suffix:e},optout:function(){var e=this.options.cookie;this.cookie.set(e.prefix+this.key,this.original,e.days,e.baseDomain)},saveGroup:function(e){_gaq.push(["_setCustomVar",this.options.ga.slot,this.key,e,this.options.ga.scope]),_gaq.push(["_trackEvent","experiments","join",this.key+"|"+e])},toJSON:function(){return{current:this.current,group:this.get(),groups:this.groups}},_normalizeGroup:function(e){var t=[],r=0;for(var i in e)if(e.hasOwnProperty(i))for(var o=0,n=this.usersPerGroup;n>o;o++)t.push(i),r++;for(var s=100-r;--s>=0;)t.push(this.original);return t}}),t}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t){var r=this.Monaco=this.Monaco||{},i=r.utils=r.utils||{};r.on("app:built",function(e){e.transitions={}}),r.Application.prototype.transitionTo=function(e,t,i){if(!e)throw new Error("Monaco :: missing target view");var o=this.currentView||null,n=i||this.transitions.DefaultTransition||r.Transition,s=new n;this.currentView=s.start(o,e,t)};var o=r.Transition=function(){this.initialize.apply(this,arguments)};return e.extend(r.Transition.prototype,t.Events,{namespace:"transitions",initialize:function(){},start:function(e,t,r){return r=r||{},e&&t.el===e.el?(e.remove(),t.render(r)):e?(t.render(r),e.remove()):t.render(r),t}}),o.extend=i.extend,r});
//# sourceMappingURL=monaco.min.js.map